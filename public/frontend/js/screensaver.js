/**
 *
 *
 */
YUI.add("stalker-screensaver", function(Y) {

    var ScreenSaver = Y.Base.create("stalker-screensaver", Y.Widget, [], {
        CONTENT_TEMPLATE: "<div><div></div></div>",
        initializer: function() {
            var cb = this.get("contentBox");                                    // Retrieve current widget node, the one we animate
            //cb.getDOMNode()
            this.anim = new Y.Anim({
                node: this.get("contentBox"),
                duration: 0.1
                        //easing: Y.Easing.elasticOut
            });                                                                 // Create the anim object
            cb.hide();
        },
        run: function() {

            //var data = '{"start":{"x":158,"y":398.5},"curves":[{"x1":162.568,"y1":399.025,"x2":158.851,"y2":402.663,"x":160.26,"y":400.988},{"x1":160.631,"y1":400.548,"x2":161.049,"y2":400.144,"x":161.455,"y":399.737},{"x1":162.573,"y1":398.618,"x2":163.776,"y2":397.581,"x":164.971,"y":396.546},{"x1":168.441,"y1":393.537,"x2":172.066,"y2":390.699,"x":175.706,"y":387.9},{"x1":183.687,"y1":381.764,"x2":191.822,"y2":375.832,"x":199.831,"y":369.729},{"x1":224.722,"y1":350.76,"x2":249.996,"y2":332.26,"x":273.594,"y":311.673},{"x1":321.851,"y1":269.576,"x2":372.108,"y2":229.563,"x":417.883,"y":184.703},{"x1":431.73,"y1":171.132,"x2":446.472,"y2":157.62,"x":462.473,"y":146.61},{"x1":473.598,"y1":138.956,"x2":488.099,"y2":133.589,"x":496.159,"y":122.262},{"x1":494.72,"y1":122.262,"x2":493.281,"y2":122.262,"x":491.842,"y":122.262},{"x1":492.377,"y1":123.331,"x2":492.911,"y2":124.4,"x":493.446,"y":125.469},{"x1":494.269,"y1":127.115,"x2":493.449,"y2":124.508,"x":493.509,"y":125.893},{"x1":493.532,"y1":126.427,"x2":493.639,"y2":126.965,"x":493.729,"y":127.491},{"x1":494.083,"y1":129.557,"x2":495.229,"y2":131.554,"x":496.337,"y":133.296},{"x1":499.846,"y1":138.816,"x2":504.959,"y2":143.364,"x":509.854,"y":147.612},{"x1":522.875,"y1":158.91,"x2":537.334,"y2":168.548,"x":551.519,"y":178.298},{"x1":557.07,"y1":182.113,"x2":562.699,"y2":185.861,"x":568.031,"y":189.981},{"x1":577.615,"y1":197.386,"x2":586.24,"y2":206.347,"x":595.113,"y":214.578},{"x1":615.764,"y1":233.734,"x2":636.403,"y2":252.954,"x":658.739,"y":270.159},{"x1":660.262,"y1":271.333,"x2":662.559,"y2":269.736,"x":662.501,"y":268},{"x1":661.488,"y1":238.274,"x2":659.537,"y2":208.589,"x":656.501,"y":179},{"x1":656.088,"y1":179.72,"x2":655.676,"y2":180.439,"x":655.263,"y":181.159},{"x1":661.604,"y1":177.888,"x2":669.97,"y2":177.642,"x":676.923,"y":177.151},{"x1":686.259,"y1":176.492,"x2":695.711,"y2":176.558,"x":705.019,"y":177.565},{"x1":710.315,"y1":178.137,"x2":718.623,"y2":178.551,"x":720.485,"y":184.516},{"x1":723.135,"y1":193.013,"x2":722.675,"y2":202.834,"x":722.953,"y":211.639},{"x1":723.299,"y1":222.618,"x2":724.274,"y2":233.543,"x":724.437,"y":244.537},{"x1":724.636,"y1":257.902,"x2":723.838,"y2":271.047,"x":723.097,"y":284.375},{"x1":722.456,"y1":295.899,"x2":722.909,"y2":307.628,"x":728.032,"y":318.18},{"x1":733.427,"y1":329.291,"x2":744.803,"y2":338.531,"x":753.958,"y":346.456},{"x1":776.339,"y1":365.831,"x2":801.381,"y2":381.954,"x":824.234,"y":400.768},{"x1":824.601,"y1":399.375,"x2":824.969,"y2":397.982,"x":825.337,"y":396.59},{"x1":800.825,"y1":401.351,"x2":775.836,"y2":400.59,"x":751.002,"y":401.501},{"x1":749.556,"y1":401.554,"x2":748.614,"y2":402.604,"x":748.502,"y":404.001},{"x1":745.975,"y1":435.35,"x2":747.473,"y2":466.819,"x":749.121,"y":498.173},{"x1":750.791,"y1":529.931,"x2":752.286,"y2":561.737,"x":752.822,"y":593.538},{"x1":753.063,"y1":607.869,"x2":752.213,"y2":622.183,"x":752.41,"y":636.501},{"x1":752.55,"y1":646.562,"x2":753.413,"y2":657.05,"x":750.333,"y":666.784},{"x1":746.394,"y1":679.233,"x2":732.532,"y2":680.614,"x":721.306,"y":681.385},{"x1":706.962,"y1":682.369,"x2":692.515,"y2":680.537,"x":678.236,"y":679.382},{"x1":647.305,"y1":676.879,"x2":615.944,"y2":679.362,"x":584.947,"y":679.494},{"x1":551.634,"y1":679.636,"x2":518.316,"y2":679.501,"x":485.003,"y":679.501},{"x1":451.796,"y1":679.501,"x2":418.583,"y2":679.697,"x":385.378,"y":679.324},{"x1":352.768,"y1":678.959,"x2":320.16,"y2":678.151,"x":287.545,"y":678.528},{"x1":270.017,"y1":678.73,"x2":252.494,"y2":679.338,"x":235.003,"y":680.501},{"x1":235.836,"y1":681.334,"x2":236.67,"y2":682.168,"x":237.503,"y":683.001},{"x1":237.469,"y1":635.721,"x2":234.938,"y2":588.461,"x":235.612,"y":541.178},{"x1":236.288,"y1":493.773,"x2":240.247,"y2":446.432,"x":238.503,"y":399.001},{"x1":238.453,"y1":397.647,"x2":237.403,"y2":396.491,"x":236.003,"y":396.501},{"x1":219.687,"y1":396.62,"x2":203.535,"y2":399.333,"x":187.216,"y":399.509},{"x1":182.465,"y1":399.561,"x2":177.705,"y2":400.124,"x":172.969,"y":400.469},{"x1":170.753,"y1":400.631,"x2":168.535,"y2":400.754,"x":166.314,"y":400.819}]}';
            var data = this.get("dream");
            var json = JSON.stringify(data)

            obj = JSON.parse(json);

            this.show();            // Show the widget

            Y.log("ScreenSaver.run()");

            var nbStrokes = obj.strokes.length;

            for (var j = 0; j < nbStrokes; j++){

                var nbCurves = obj.strokes[j].curves.length;
                //from json setInitial position
                this.get("contentBox").setXY([obj.strokes[j].start.x, obj.strokes[j].start.y]);

                this.currentIndex = 0;
                this.j = j;
                this.nbstrokes = nbStrokes;
                this.currentAnim = [];

                for (var i = 0; i < nbCurves; i++) {
                    x1 = obj.strokes[j].curves[i].x1;
                    y1 = obj.strokes[j].curves[i].y1;
                    x2 = obj.strokes[j].curves[i].x2;
                    y2 = obj.strokes[j].curves[i].y2;
                    x = obj.strokes[j].curves[i].x;
                    y = obj.strokes[j].curves[i].y;

                    this.currentAnim.push({curve: [[x1, y1],[x2, y2],[x,y]]})

                }

                this._step();

            }

            
        },
        _step: function() {
            var nextPoint = this.currentAnim[this.currentIndex];

            if (nextPoint) {
                this.anim.set("to", nextPoint);
                this.anim.once("end", this._step, this);
                this.anim.run();
                this.currentIndex += 1;                                         // Increment index
            }else {
                if(parseInt(this.j,10) != parseInt((this.nbStrokes-1),10)){                     // No more points: animation is over
                    this.fire("drawingEnd");
                    this.hide();

                }
            }
        },
        show: function() {
            ScreenSaver.superclass.hide.call(this);
            this.get("contentBox").show(true);
        },
        hide: function() {
            ScreenSaver.superclass.hide.call(this);
            this.get("contentBox").hide(true);
            this.anim.pause();

            //Y.one('#screen-saver').hide();
            //$('#asd').trigger('pause');
            //$('div#draw-tool').fadeOut('slow');
            //Y.one("#screen-saver").show(true);
        }
    },{
        ATTRS: {
            dream:{
                value: null
            }
        }
    });
    Y.namespace("Stalker").ScreenSaver = ScreenSaver;
});
