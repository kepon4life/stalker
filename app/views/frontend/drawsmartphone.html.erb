<% @title="Stalker - draw with smartphone" %>
<% content_for :custom_meta_tags do %>
<meta name="viewport" content="width = device-width, initial-scale = 1.0, user-scalable = no">
<% end %>
<% content_for :stylesheet_includes do %>
	<%= stylesheet_link_tag '/frontend/css/colorpicker.css'  %>
	<%= stylesheet_link_tag '/frontend/css/literally.css'  %>
	<style type="text/css">
            body {
                font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
                margin: 0;
                background: black;
                color: white;
                text-align:center;
                font-size: 34px;
            }
            .fs-container {
                position: fixed;
                width: 100%;
                height: 100%;
            }
            .literally {
                position: absolute;
                bottom: 0;
                width: 100%;
                height: 100%;
            }
            /* let's make things a bit bigger */
            .literally .button, .literally .zoom-display {
                line-height: 28px;
                font-size: 18px;
            }
            .literally .toolbar-row-right {
                width: 20em;
            }
            .literally .button {
                padding: 5px 15px 5px 15px;
            }
            .literally .button.color-square {
                padding-top: 10px;
                height: 23px;
            }
            .literally .tools .button {
                padding: 6px 13px 2px 15px;
                line-height: 24px;
            }
            .literally .tools .button img {
                width: 24px;
                height: 24px;
            }
            .literally input[type=range] {
                width: 200px;
            }
            /* Hide unused buttons */
            .literally .toolbar {
                height: 0px;
            }
            .literally .toolbar .button,
            .literally .toolbar .tool-options-container,
            .literally .toolbar .zoom-display {
                display: none;
            }
            .literally .toolbar .clear-button,
            .literally .toolbar .send-button,
            .literally .toolbar .undo-button {
                display: inline-block;
                border: none;
                border-radius: 0;
                width: 97px;
                height: 97px;
                padding: 0;
                color: transparent;
                text-shadow: none;
                background: transparent url(frontend/img/UI_send.png);
            }
            .literally .toolbar .send-button {
                position: absolute;
                bottom: 10px;
                right: 10px;
            }
            .literally .toolbar .clear-button:hover {
                color: transparent;
                background: transparent url(frontend/img/UI_newpage.png) no-repeat;
            }
            .literally .toolbar .clear-button {
                background: transparent url(frontend/img/UI_newpage.png) no-repeat;
                position: absolute;
                left: 10px;
                bottom: 10px;
            }
            .literally .toolbar .undo-button {
                position: absolute;
                bottom: 10px;
                left: 120px;
                background: transparent url(frontend/img/UI_undo.png) no-repeat;
            }
            .msg {
                position: fixed;
                width: 100%;
                top: 0;
                left: 0;
                z-index: 1000;
                bottom:0px;
                background:black;
                text-align:center;
            }
            .msg .logo {
                position: absolute;
                top: 10px;
                left 10px;
                background: transparent url(frontend/img/UI_logo_300.png) no-repeat;
                width:300px;
                height:114px;
            }
            @font-face {
                font-family: RaleighRock;
                src: url('frontend/font/RaleighRock.ttf');
            }
            .msg .text {
                font-family: RaleighRock, Helvetica;
                line-height: 53px;
                top: 50%;
                position: absolute;
                width: 100%;
                left: 0;
                margin-top: -130px;
            }
            .msg .text a {
                text-decoration: underline;
                color:white;
            }
            .msg.invite .text {
                line-height: 87px;
                font-size: 1.9em;
            }

            .msg.invite{
                pointer-events: none;
            }

        </style>
<% end %>
<% content_for :javascript_includes do %>
    <%= javascript_include_tag "/frontend/js/libs/literallycanvas.fat.js" %>
    <script type="text/javascript">
        // var DESTINATION_HEIGHT = 512,
        // DESTINATION_WIDTH = 512;

        $(document).ready(function() {
            function getURLParameter(name) {
                return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null
            }

            //Pusher
            if (window.Pusher) {
                Pusher.channel_auth_endpoint = 'pusher/auth';
                var pusher = new Pusher(PUSHER_API_KEY);
                var privateChannel = pusher.subscribe(PUSHER_CHANEL);
                var triggered;

                privateChannel.bind('pusher:subscription_error', function(status) {
                    console.log("error "+status);
                });
            }
            // disable scrolling on touch devices so we can actually draw
            $(document).bind('touchmove', function(e) {
                if (e.target === document.documentElement) {
                    return e.preventDefault();
                }
            });

            $('.literally').literallycanvas({
                imageURLPrefix: "img/",
                backgroundColor: 'rgb(0, 0, 0)',
                toolClasses: [LC.Pencil]
            });

            setTimeout(function() {
              $('.invite').fadeOut(3000);
            }, 500);

            $('.clear-button').parent().prepend('<div class="button send-button">Send</div>');
            $('.send-button').on("click", function() {
                var canvas = $('.literally').canvasForExport();
                //$('body').empty().append(canvas);
                $.ajax({
                    type: 'POST',
                    url: '/frontend/save',
                    data: {
                        metadatas : JSON.stringify({
                            event: getURLParameter("event")
                        }),
                        imgNormal: canvas.toDataURL("image/png")
                    },
                    success: function(data) {
                        triggered = privateChannel.trigger('client-myevent', data);
                        console.log(data);
                        var url = "dream/" + data.dream_id + "?token=" + data.token;
                        $('.msg-sent .text a').each(function( index, element ) {
                            $(element).attr("href", url);
                        }); 
                        $('.msg-sent').fadeIn(1000);
                    }
                });
            });
$('.msg-sent').hide();
//                        $('.msg-sent').fadeIn(1000);
        });
    </script>
<% end %>

<div class="invite msg">
    <div class="logo"></div>
    <div class="text">
        DESSINEZ VOTRE REVE.<br /><br />
        DRAW YOUR WISH.
    </div>
</div>

<div class="msg-sent msg">
    <div class="logo"></div>
    <div class="text">
        MERCI DE VOTRE PARTICIPATION,<br />
        RETROUVEZ-LA <a href="#">ICI</a>.
        <br /><br />
        THANK FOR YOUR PARTICIPATION,<br />
        FIND IT <a href="#">HERE</a>.
    </div>
</div>

<div class="fs-container">
	<div class="literally"><canvas></canvas></div>
</div>
